# 图片压缩功能测试指南

## 测试前准备

### 1. 准备测试图片

准备以下类型的测试图片：

- **大尺寸图片**: 3000x2000 或更大
- **大文件**: 2-5 MB
- **小文件**: < 500 KB
- **不同格式**: JPEG, PNG, WebP
- **多张图片**: 5-10张用于批量测试

### 2. 部署更新

#### 前端部署

```bash
# 构建前端
npm run build

# 如果使用 Vercel
vercel --prod

# 或者其他部署方式
```

#### 后端部署

```bash
# 进入 workers 目录
cd workers

# 部署到 Cloudflare
npm run deploy
```

## 测试步骤

### 测试 1: 单张大图片压缩

**目的**: 验证大图片能正确压缩

1. 打开管理后台 (通常是 `/admin`)
2. 点击"添加商品"
3. 填写商品名称和分类
4. 上传一张大图片（例如 3000x2000, 3MB）
5. 观察压缩过程：
   - ✅ 应显示"正在压缩图片"提示
   - ✅ 应显示压缩进度条
   - ✅ 应显示压缩完成通知，包含原始/压缩后大小
6. 打开浏览器控制台，检查日志：
   ```
   图片压缩完成: xxx.jpg
     原始大小: XXXX KB
     压缩后: XXX KB
     压缩率: XX%
     尺寸: 3000x2000 -> 1920x1280
   ```
7. 提交表单
8. 验证结果：
   - ✅ 图片成功上传
   - ✅ 在产品列表中显示正常
   - ✅ 图片质量可接受

**预期结果**:
- 压缩率: 70-90%
- 尺寸: 不超过 1920x1920
- 文件大小: 通常 200-500 KB
- 质量: 肉眼几乎无差异

---

### 测试 2: 批量图片压缩

**目的**: 验证多张图片批量压缩

1. 点击"添加商品"
2. 选择 5-10 张图片（不同大小和格式）
3. 观察：
   - ✅ 进度条显示 "1/5", "2/5" 等
   - ✅ 显示总的原始/压缩后大小
4. 检查控制台，应该有每张图片的压缩日志
5. 提交并验证所有图片都正确上传

**预期结果**:
- 所有图片都被处理
- 进度准确显示
- 总体压缩效果明显

---

### 测试 3: 小图片跳过压缩

**目的**: 验证已优化的图片不会被二次压缩

1. 上传一张已经很小的图片（< 500KB，尺寸 < 1920x1920）
2. 检查控制台日志：
   ```
   图片 xxx.jpg 无需压缩
   ```
3. 验证图片正常上传

**预期结果**:
- 小图片快速通过
- 不进行不必要的压缩
- 保持原始质量

---

### 测试 4: 编辑产品添加图片

**目的**: 验证编辑时的压缩功能

1. 编辑现有产品
2. 添加新图片（大图片）
3. 观察压缩过程
4. 保存并验证

**预期结果**:
- 新添加的图片被压缩
- 不影响现有图片
- 图片顺序正确

---

### 测试 5: 超大文件验证

**目的**: 验证后端文件大小限制

1. 尝试上传一个超大文件（> 5MB）
   - 可以通过修改前端压缩参数临时禁用压缩来测试
   - 或者上传一个超大的 PNG 文件（压缩率较低）
2. 应该看到错误提示：
   ```
   图片 "xxx.png" 太大。文件大小: X.XX MB，最大允许: 5MB
   ```

**预期结果**:
- 后端正确拦截超大文件
- 显示清晰的错误信息
- 不会上传失败的文件

---

### 测试 6: 非图片文件验证

**目的**: 验证文件类型验证

1. 尝试上传非图片文件（PDF, TXT 等）
2. 应该看到错误提示：
   ```
   文件 "xxx.pdf" 不是有效的图片格式
   ```

**预期结果**:
- 正确拒绝非图片文件
- 清晰的错误提示

---

### 测试 7: 网络和性能

**目的**: 验证压缩对上传速度的影响

1. 打开浏览器开发者工具 - Network 标签
2. 上传 5 张大图片（各 3MB）
3. 观察网络请求：
   - 记录上传的数据量
   - 记录上传时间
4. 与未压缩相比（如果有历史数据）

**预期结果**:
- 上传数据量显著减少
- 上传时间缩短
- 带宽使用优化

---

### 测试 8: 压缩失败处理

**目的**: 验证错误处理

1. 上传一个损坏的图片文件（可选测试）
2. 或者在开发者工具中模拟网络错误
3. 观察错误处理

**预期结果**:
- 显示友好的错误消息
- 不会导致整个应用崩溃
- 控制台有详细错误日志

---

## 性能基准测试

### 压缩前后对比

| 测试项 | 原始 | 压缩后 | 改进 |
|-------|------|--------|------|
| 单图文件大小 | 3.2 MB | 320 KB | 90% |
| 5图总大小 | 15 MB | 1.5 MB | 90% |
| 上传时间（4G） | 30s | 3s | 90% |
| 页面加载时间 | 5s | 0.8s | 84% |

### 质量对比

1. 并排比较原图和压缩后的图片
2. 在不同设备上查看（手机、平板、桌面）
3. 评分标准：
   - ⭐⭐⭐⭐⭐ 无法区分
   - ⭐⭐⭐⭐ 仔细看能发现细微差异
   - ⭐⭐⭐ 能看出差异但可接受
   - ⭐⭐ 明显质量下降
   - ⭐ 不可接受

**目标**: ⭐⭐⭐⭐ 或以上

---

## 浏览器兼容性测试

测试以下浏览器：

- [ ] Chrome（最新版）
- [ ] Firefox（最新版）
- [ ] Safari（最新版）
- [ ] Edge（最新版）
- [ ] 移动浏览器（iOS Safari, Chrome Mobile）

**预期**: 所有浏览器都能正常工作

---

## 验收标准

### 必须通过

- ✅ 大图片能成功压缩（> 70% 压缩率）
- ✅ 批量上传正常工作
- ✅ 压缩不影响图片质量（目测）
- ✅ 进度显示准确
- ✅ 错误处理正确
- ✅ 后端验证工作正常
- ✅ 所有浏览器兼容

### 性能指标

- ✅ 平均压缩率 > 70%
- ✅ 单图压缩时间 < 2 秒
- ✅ 批量压缩（10张）< 10 秒
- ✅ 压缩后图片质量 ≥ ⭐⭐⭐⭐

---

## 问题排查

### 问题 1: 压缩不生效

**可能原因**:
- 前端代码未更新
- 浏览器缓存

**解决方法**:
```bash
# 清除构建缓存
rm -rf dist .cache

# 重新构建
npm run build

# 清除浏览器缓存
Ctrl/Cmd + Shift + R
```

### 问题 2: 压缩太慢

**可能原因**:
- 图片过大
- 浏览器性能

**解决方法**:
- 调整压缩参数（降低质量或尺寸）
- 优化算法
- 使用 Web Workers（未来改进）

### 问题 3: 图片质量不佳

**可能原因**:
- 质量参数太低
- 源图片质量差

**解决方法**:
```typescript
// 在 Admin.tsx 中调整质量参数
quality: 0.90, // 从 0.85 提高到 0.90
```

### 问题 4: 后端拒绝文件

**可能原因**:
- 文件太大（> 5MB）
- 格式不支持

**解决方法**:
- 调整前端压缩参数使文件更小
- 或调整后端限制（workers/src/index.ts）

---

## 监控和日志

### 前端日志

打开浏览器控制台查看：
- 压缩详情
- 错误信息
- 性能指标

### 后端日志

在 Cloudflare Dashboard 查看：
1. Workers & Pages → 你的 Worker
2. Logs → Real-time Logs
3. 查看上传和验证日志

---

## 回归测试清单

每次修改压缩功能后，快速验证：

- [ ] 上传单张大图片
- [ ] 上传多张图片
- [ ] 编辑产品添加图片
- [ ] 检查控制台无错误
- [ ] 验证压缩效果
- [ ] 检查产品页面图片显示正常

---

## 测试报告模板

```
### 测试日期: YYYY-MM-DD
### 测试人员: [名字]
### 测试环境: [浏览器/设备]

#### 测试结果摘要
- 总测试用例: X
- 通过: X
- 失败: X
- 跳过: X

#### 详细结果
1. [测试名称]: ✅ / ❌
   - 说明: ...
   - 截图: ...

#### 性能数据
- 平均压缩率: X%
- 平均压缩时间: X 秒
- 图片质量评分: ⭐⭐⭐⭐

#### 问题和建议
- ...

#### 总结
[通过/需要修复]
```

---

## 下一步

测试通过后：

1. ✅ 标记功能为"已完成"
2. 📝 更新用户文档
3. 🚀 发布到生产环境
4. 📊 监控实际使用效果
5. 💡 收集用户反馈
6. 🔧 根据反馈优化参数

---

## 相关文档

- [IMAGE_COMPRESSION_GUIDE.md](./IMAGE_COMPRESSION_GUIDE.md) - 功能说明
- [Admin页面](src/pages/Admin.tsx) - 实现代码
- [压缩工具](src/lib/imageCompressor.ts) - 核心算法

