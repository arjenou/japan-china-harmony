# 自定义域名配置指南

## 为 Workers API 配置自定义域名 www.mono-grp.com/api

### 前提条件
- 域名 `mono-grp.com` 已经添加到 Cloudflare
- Workers 已经部署成功

### 配置步骤

#### 1. 登录 Cloudflare Dashboard
访问：https://dash.cloudflare.com

#### 2. 进入 Workers 设置
1. 点击左侧菜单 **Workers & Pages**
2. 找到并点击 `yingwu-admin` worker
3. 点击 **Settings** 标签
4. 选择 **Triggers** 子标签

#### 3. 添加自定义域名
在 **Custom Domains** 部分：
1. 点击 **Add Custom Domain**
2. 输入：`www.mono-grp.com`
3. 点击 **Add Custom Domain**

Cloudflare 会自动：
- 创建 DNS 记录
- 配置 SSL 证书
- 设置路由规则

#### 4. 验证配置
等待 DNS 生效（通常 1-5 分钟），然后测试：

```bash
# 测试 API 连接
curl https://www.mono-grp.com/api/categories

# 测试产品列表
curl https://www.mono-grp.com/api/products
```

#### 5. 路由说明
配置完成后，以下 URL 都会指向您的 Workers：

- `https://www.mono-grp.com/api/products` - 获取产品列表
- `https://www.mono-grp.com/api/products/:id` - 获取单个产品
- `https://www.mono-grp.com/api/images/*` - 获取图片
- `https://www.mono-grp.com/api/categories` - 获取分类列表

### 可选：配置路由规则

如果您想要更精细的路由控制，可以使用 **Routes** 方式：

1. 在 **Routes** 部分点击 **Add route**
2. 输入路由模式：`www.mono-grp.com/api/*`
3. 选择 Zone：`mono-grp.com`
4. 点击 **Add route**

### 注意事项

1. **DNS 记录**：Cloudflare 会自动创建 DNS 记录，无需手动配置
2. **SSL 证书**：自动配置，支持 HTTPS
3. **缓存**：API 响应已配置缓存控制头
4. **CORS**：已配置允许所有来源，如需限制可修改 `workers/src/index.ts`

### 前端代码已更新

前端代码中的 API_BASE_URL 已更新为：
```typescript
const API_BASE_URL = 'https://www.mono-grp.com';
```

涉及的文件：
- `src/components/Products.tsx`
- `src/pages/ProductDetail.tsx`
- `src/pages/Admin.tsx`

### 回退方案

如果需要回退到 Workers 默认域名：

1. 将前端代码中的 API_BASE_URL 改回：
```typescript
const API_BASE_URL = 'https://yingwu-admin.wangyunjie1101.workers.dev';
```

2. 在 Cloudflare Dashboard 中删除自定义域名配置

### 故障排查

#### 域名不可访问
- 检查 DNS 是否生效：`dig www.mono-grp.com`
- 确认域名在 Cloudflare 中状态为 "Active"
- 等待 DNS 传播完成（最长 24 小时）

#### CORS 错误
- 检查 `workers/src/index.ts` 中的 CORS 配置
- 确认 `ALLOWED_ORIGINS` 环境变量设置正确

#### 图片无法加载
- 确认 R2 bucket 配置正确
- 检查图片 URL 格式：`https://www.mono-grp.com/api/images/文件名`

### 监控和日志

查看 Workers 日志：
1. Cloudflare Dashboard > Workers & Pages
2. 点击 `yingwu-admin`
3. 点击 **Logs** 标签
4. 选择 **Begin log stream**

### 性能优化

自定义域名配置后，建议：
1. 开启 Cloudflare CDN 缓存
2. 配置适当的缓存规则
3. 监控 API 响应时间

### 完成！

配置完成后，您的 API 将通过以下地址访问：
- 主站：https://www.mono-grp.com
- API：https://www.mono-grp.com/api/*
- 管理后台：https://www.mono-grp.com/admin（如需配置）

所有测试通过后，即可将前端部署到生产环境。

